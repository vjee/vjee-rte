/**
 * @vjee/rte v0.1.0-alpha.1
 * (c) 2019-2019 vjee
 * Released under the MIT License.
 */
class t{constructor(){this.savedSelectionRange=null,this.isFakeBackgroundEnabled=!1}static get(){return window.getSelection()}save(){this.savedSelectionRange=t.range}restore(){if(!this.savedSelectionRange)return;const t=window.getSelection();t.removeAllRanges(),t.addRange(this.savedSelectionRange)}static findParentTag(t,e=null,o=10){const n=window.getSelection();let s=null;if(!n||!n.anchorNode||!n.focusNode)return null;return[n.anchorNode,n.focusNode].forEach(n=>{let a=o;for(;a>0&&n.parentNode&&(n.tagName!==t||(s=n,e&&n.classList&&!n.classList.contains(e)&&(s=null),!s));)n=n.parentNode,a--}),s}static expandToTag(t){const e=window.getSelection();e.removeAllRanges();const o=document.createRange();o.selectNodeContents(t),e.addRange(o)}static get text(){return window.getSelection?window.getSelection().toString():""}static get range(){const t=window.getSelection();return t&&t.rangeCount?t.getRangeAt(0):null}static get rect(){let t={x:0,y:0,width:0,height:0};const e=window.getSelection().getRangeAt(0).cloneRange();return e.getBoundingClientRect&&(t=e.getBoundingClientRect()),t}}class e{constructor(t,e){this.$button=t,this.toolbar=e}surround(){const e=t.range,o=t.findParentTag(this.nodeName.toUpperCase());o?this.unwrap(o):this.wrap(e),this.checkState()}wrap(e){const o=document.createElement(this.nodeName);o.appendChild(e.extractContents()),e.insertNode(o),t.expandToTag(o)}unwrap(e){t.expandToTag(e);const o=t.range,n=o.extractContents();e.parentNode.removeChild(e),o.insertNode(n);const s=window.getSelection();s.removeAllRanges(),s.addRange(o)}checkState(){t.findParentTag(this.nodeName.toUpperCase())?this.$button.classList.add("active"):this.$button.classList.remove("active")}}class o extends e{constructor(t,e){super(t,e),this.name="Bold",this.nodeName="b",this.shortcut=["meta+b","ctrl+b"],this.icon='<svg height=24 viewBox="0 0 24 24"width=24 xmlns=http://www.w3.org/2000/svg><path d="M15.6 10.79c.97-.67 1.65-1.77 1.65-2.79 0-2.26-1.75-4-4-4H7v14h7.04c2.09 0 3.71-1.7 3.71-3.79 0-1.52-.86-2.82-2.15-3.42zM10 6.5h3c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5h-3v-3zm3.5 9H10v-3h3.5c.83 0 1.5.67 1.5 1.5s-.67 1.5-1.5 1.5z"fill=currentFill /><path d="M0 0h24v24H0z"fill=none /></svg>'}}class n extends e{constructor(t,e){super(t,e),this.name="Italic",this.nodeName="i",this.shortcut=["meta+i","ctrl-i"],this.icon='<svg height=24 viewBox="0 0 24 24"width=24 xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0z"fill=none /><path d="M10 4v3h2.21l-3.42 8H6v3h8v-3h-2.21l3.42-8H18V4z"fill=currentFill /></svg>'}}class s extends e{constructor(t,e){super(t,e),this.name="Mark",this.nodeName="mark",this.shortcut=["alt+meta+h","ctrl-alt-h"],this.icon='<svg height=20 viewBox="0 0 24 24"width=20 xmlns=http://www.w3.org/2000/svg><path d="M17.75 7L14 3.25l-10 10V17h3.75l10-10zm2.96-2.96c.39-.39.39-1.02 0-1.41L18.37.29c-.39-.39-1.02-.39-1.41 0L15 2.25 18.75 6l1.96-1.96z"fill=currentFill /><path d="M0 0h24v24H0z"fill=none /><path d="M0 20h24v4H0z"fill=currentFill fill-opacity=.36 /></svg>'}}class a{constructor(t,e){this.$button=t,this.toolbar=e,this.name="Link",this.nodeName="a",this.shortcut=["meta+k","ctrl+k"],this.icon='<svg height=24 viewBox="0 0 24 24"width=24 xmlns=http://www.w3.org/2000/svg><path d="M0 0h24v24H0z"fill=none /><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"fill=currentFill /></svg>'}surround(){const e=t.range,o=t.findParentTag(this.nodeName.toUpperCase());o?this.unwrap(o):this.wrap(e),this.checkState()}wrap(t){const e=prompt("Link location:");document.execCommand("createLink",!1,e)}unwrap(e){t.expandToTag(e),document.execCommand("unlink")}checkState(){t.findParentTag("A")?this.$button.classList.add("active"):this.$button.classList.remove("active")}}class i{constructor(t,e){this.toolInstances=[],this.shortcuts={},this.$node=t,this.selection=e,this.$toolbar=this.createToolbar(),this.isMac=0===navigator.platform.indexOf("Mac"),[o,n,s,a].forEach(t=>{const e=this.createToolbarButton(t);this.$toolbar.firstChild.appendChild(e)}),document.body.appendChild(this.$toolbar)}createToolbar(){const t=document.createElement("div");t.classList.add("vjee-rte__toolbar"),t.classList.add("vjee-rte__toolbar--hidden");const e=document.createElement("div");return e.classList.add("vjee-rte__toolbar__buttons"),t.appendChild(e),t}createToolbarButton(t){const e=document.createElement("button");e.classList.add("vjee-rte__toolbar__button");const o=new t(e,this);if(this.toolInstances.push(o),e.title=o.name,e.innerHTML=o.icon,e.addEventListener("click",()=>{o.surround()}),o.shortcut){const t=this.isMac?o.shortcut[0]:o.shortcut[1],n=this.isMac?t.replace("meta","⌘").replace("alt","⌥"):t;this.shortcuts[t]=()=>o.surround(),e.title=`${o.name} (${n.toUpperCase()})`}return e}allowedToShow(){const e=t.get(),o=t.text;if(e.isCollapsed||o.length<1)return!1;const n=e.anchorNode.parentElement;return!!this.$node.contains(n)}checkStates(){this.toolInstances.forEach(t=>{t.checkState&&t.checkState()})}move(){const e=t.rect,o={x:e.left+e.width/2,y:e.top+e.height};this.$toolbar.style.left=Math.floor(o.x)+"px",this.$toolbar.style.top=Math.floor(o.y)+"px"}open(){this.$toolbar.classList.remove("vjee-rte__toolbar--hidden")}close(){this.$toolbar.classList.add("vjee-rte__toolbar--hidden"),this.toolInstances.forEach(t=>{t.clearUI&&t.clearUI()})}destroy(){this.$toolbar.parentNode.removeChild(this.$toolbar)}}export default function(e){"string"==typeof e&&(e=document.querySelector(e));const o=new t,n=new i(e,o),s=function(t,e=!1){return o=>{if(!o)return;e&&o.preventDefault();let n=[o.ctrlKey?"ctrl":void 0,o.altKey?"alt":void 0,o.shiftKey?"shift":void 0,o.metaKey?"meta":void 0,["Shift","Meta","Control","Option","Alt"].indexOf(o.key)>=0?void 0:o.code.replace(/Key|Digit/,"")].filter(Boolean);n.length>=2&&t&&t(n.join("+").toLowerCase(),o)}}(t=>{console.log(t),n.shortcuts[t]&&n.shortcuts[t]()},!0);function a(){if(!n.allowedToShow())return n.close();o.save(),n.move(),n.open(),n.checkStates()}return e.classList.add("vjee-rte"),e.contentEditable="true",window.addEventListener("mouseup",a),window.addEventListener("keyup",a),window.addEventListener("keydown",s),function(){e.classList.remove("vjee-rte"),e.contentEditable="false",window.removeEventListener("mouseup",a),window.removeEventListener("keyup",a),window.removeEventListener("keydown",s),n.destroy()}}
